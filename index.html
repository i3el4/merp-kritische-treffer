<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <title>MERS — Angriffs- & Krit-Tabellen (PWA-Prototyp)</title>
  <meta name="description" content="Schnelles Nachschlagen von Angriffen und kritischen Treffern für MERS/MERP." />

  <!-- Aniron Font (lokal) -->
  <style>
    @font-face {
      font-family: 'Aniron';
      src: url('assets/fonts/Aniron-Regular.ttf') format('truetype'),
           url('assets/fonts/Aniron.ttf') format('truetype');
      font-display: swap;
    }
  </style>

  <style>
    :root{
      --bg: #f7f7fb;
      --panel: #ffffff;
      --muted: #5b6472;
      --text: #0f172a;
      --accent: #2563eb;
      --ok:#16a34a;
      --warn:#b45309;
      --danger:#b91c1c;
      --cardborder:#e5e7eb;
      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:clamp(22px,5vw,32px);margin:0;letter-spacing:.2px;font-family:'Aniron', Georgia, 'Times New Roman', serif}
    h2{font-size:clamp(16px,3.5vw,20px);margin:0 0 8px 0;font-family:'Aniron', Georgia, 'Times New Roman', serif}
    .sub{color:var(--muted);font-size:13px}

    /* Mobile-first: eine Spalte, ab 860px zwei Spalten */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 860px){.grid{grid-template-columns:1.05fr .95fr}}

    .card{background:var(--panel);border:1px solid var(--cardborder);border-radius:14px;box-shadow:0 6px 16px rgba(15,23,42,.06);padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0}
    label{font-size:13px;color:var(--muted)}
    select,input[type=number]{background:#fff;border:1px solid #d1d5db;border-radius:12px;color:var(--text);padding:10px 12px;font-size:16px;min-width:160px}
    input[type=number]{width:160px}
    select:focus,input:focus{outline:3px solid rgba(37,99,235,.25);border-color:#93c5fd}

    .rk{display:flex;flex-wrap:wrap;gap:6px}
    .rk button{border:1px solid #d1d5db;background:#fff;color:#111827;border-radius:999px;padding:8px 10px;font-size:14px;cursor:pointer}
    .rk button.active{background:#e0ecff;border-color:#93c5fd;box-shadow:0 0 0 2px rgba(37,99,235,.18) inset}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#f3f4f6;border:1px solid #d1d5db;color:#111827;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1e40af;color:#fff}
    .btn.ghost{background:transparent}

    .out{background:#fbfbfe;border:1px dashed #cbd5e1;border-radius:14px;padding:10px;margin-top:8px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:var(--chip);border:1px solid #c7d2fe;color:#1f2937;border-radius:999px;padding:6px 10px;font-size:13px}
    .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .pill.danger{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
    .result{font-size:15px;margin-top:6px}
    .muted{color:var(--muted)}
    details summary{cursor:pointer;user-select:none}
    hr{border:none;border-top:1px solid #e5e7eb;margin:12px 0}
    .audio-controls{display:flex;gap:10px;align-items:center}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:4px 8px;color:#1f2937}
    .monospace{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .foot{color:#6b7280;margin-top:10px;font-size:12px}
    .sr{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>MERS • Angriffe & Krits</h1>
        <div class="sub">Prototyp (PWA). Lädt <span class="monospace">assets/treffer_tabellen_strukturiert.json</span> & <span class="monospace">assets/tables.json</span>. Audio unter <span class="monospace">assets/audio/</span>.</div>
      </div>
      <button class="btn" id="installBtn" hidden>Installieren</button>
    </header>

    <div class="grid">
      <!-- Eingabe -->
      <section class="card">
        <h2>1) Angriff</h2>
        <div class="row">
          <div>
            <label for="weapon">Waffenart</label><br>
            <select id="weapon" aria-label="Waffenart"></select>
          </div>
          <div>
            <label>Rüstungsklasse (RK)</label><br>
            <div class="rk" id="rk"></div>
          </div>
          <div>
            <label for="attack">Angriffswert (berechnet)</label><br>
            <input id="attack" type="number" inputmode="numeric" placeholder="z. B. 126" />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="calcAttack">Treffer ermitteln</button>
          <button class="btn ghost" id="resetBtn">Zurücksetzen</button>
        </div>
        <div class="out" id="attackOut">
          <div class="kpi" id="attackKpi"></div>
          <div class="result muted">Noch kein Ergebnis.</div>
        </div>
      </section>

      <!-- Ausgabe + Krit -->
      <section class="card">
        <h2>2) Kritischer Haupttreffer</h2>
        <div class="row">
          <div>
            <label for="critRoll">Wurf 1–100</label><br>
            <input id="critRoll" type="number" min="1" max="100" placeholder="z. B. 66" />
          </div>
          <div>
            <label for="critType">Krit-Typ</label><br>
            <select id="critType">
              <option value="">(auto aus Schritt 1)</option>
              <option value="Stich">Stich (P)</option>
              <option value="Streich">Streich (S)</option>
              <option value="Hieb">Hieb (K)</option>
              <option value="Schlag">Schlag</option>
              <option value="Hitze">Hitze</option>
            </select>
          </div>
          <div>
            <label for="critCat">Kategorie</label><br>
            <select id="critCat">
              <option value="">(auto)</option>
              <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="calcCrit">Krit suchen</button>
        </div>
        <div class="out" id="critOut">
          <div class="kpi" id="critKpi"></div>
          <div class="result muted">Noch kein Ergebnis.</div>
        </div>
        <hr>
        <details>
          <summary>3) Nebentreffer (optional)</summary>
          <div class="row">
            <div>
              <label for="sideType">Nebentreffer-Tabelle</label><br>
              <select id="sideType">
                <option value="">(eine wählen)</option>
              </select>
            </div>
            <div>
              <label for="sideCat">Kategorie</label><br>
              <select id="sideCat">
                <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
              </select>
            </div>
            <div>
              <label for="sideRoll">Wurf 1–100</label><br>
              <input id="sideRoll" type="number" min="1" max="100" placeholder="z. B. 87"/>
            </div>
          </div>
          <div class="actions">
            <button class="btn" id="calcSide">Nebentreffer suchen</button>
          </div>
          <div class="out" id="sideOut">
            <div class="kpi" id="sideKpi"></div>
            <div class="result muted">Noch kein Ergebnis.</div>
          </div>
        </details>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2>Audio & Sprache</h2>
      <div class="flex">
        <div class="audio-controls">
          <button class="btn" id="bgPlay">Musik ▶︎/⏸︎</button>
          <label class="sr" for="bgVol">Musik-Lautstärke</label>
          <input id="bgVol" type="range" min="0" max="1" step="0.01" value="0.18">
          <span class="badge">Hintergrundmusik je Tabelle</span>
        </div>
        <div class="audio-controls">
          <label class="sr" for="ttsToggle">Vorlesen</label>
          <input id="ttsToggle" type="checkbox" checked>
          <span class="badge">TTS-Fallback (falls keine MP3 gefunden)</span>
        </div>
      </div>
      <div class="foot">Bereiche werden als Dateien <span class="monospace">Typ_Kat_Bereich.mp3</span> in <span class="monospace">assets/audio/</span> gesucht (z. B. <span class="monospace">Streich_E_1-5.mp3</span>, <span class="monospace">Hitze_A_67-70.mp3</span>). Für BG-Musik werden nach Typ passende MP3s gemappt.</div>
    </section>

    <footer class="foot">
      © 2025 • Prototyp. Läuft als PWA (Installieren-Button erscheint in unterstützten Browsern).
    </footer>
  </div>

  <!-- Hintergrundmusik (loop) -->
  <audio id="bgAudio" loop></audio>
  <!-- Kritische Treffer Audio (pro Eintrag, nicht loopend) -->
  <audio id="sfxAudio"></audio>

  <script>
    // --- Datenquellen (angepasste Pfade in assets/) ---
    const TREFFER_URL = 'assets/treffer_tabellen_strukturiert.json';
    const TABLES_URL  = 'assets/tables.json';

    // --- Globaler Zustand ---
    let treffer = null;
    let tables = null;
    let autoCrit = { typ:'', kat:'' };
    let currentBgKey = null;

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // RK Buttons erzeugen
    const rkWrap = $('#rk');
    for(let i=1;i<=20;i++){
      const b = document.createElement('button');
      b.type='button'; b.textContent = i;
      b.dataset.rk = i;
      b.addEventListener('click', () => {
        $$('.rk button').forEach(x => x.classList.toggle('active', x===b));
      });
      if(i===3) b.classList.add('active'); // Default RK 3
      rkWrap.appendChild(b);
    }

    // Daten laden und UI befüllen
    async function loadData(){
      const [t1, t2] = await Promise.all([fetch(TREFFER_URL), fetch(TABLES_URL)]);
      treffer = await t1.json();
      tables  = await t2.json();

      // Waffen aus den Angriffstabellen lesen
      const wSel = $('#weapon');
      const waffen = Object.keys(treffer?.Angriffstabellen || {}).sort();
      wSel.innerHTML = '';
      waffen.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; // benutze Schlüssel exakt wie in JSON (z. B. HANDAXT)
        // Anzeige für Menschen hübscher machen
        opt.textContent = k.replace(/_/g,' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        wSel.appendChild(opt);
      });
      if(waffen.length) wSel.value = waffen[0];

      // Nebentreffer-Typen aus tables.json
      const sideSel = $('#sideType');
      sideSel.innerHTML = '<option value="">(eine wählen)</option>';
      Object.keys(tables).forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        sideSel.appendChild(opt);
      });
    }

    // Utility: nächstniedrigerer Key im Objekt (number keys)
    function floorKey(obj, target){
      const keys = Object.keys(obj).map(k => parseInt(k,10)).filter(n=>!Number.isNaN(n)).sort((a,b)=>a-b);
      let best = null;
      for(const k of keys){ if(k<=target) best = k; else break; }
      return best;
    }

    // Angriff berechnen
    $('#calcAttack').addEventListener('click', () => {
      const weapon = $('#weapon').value;
      const rk = parseInt($('.rk button.active')?.dataset.rk || '3', 10);
      const attack = parseInt($('#attack').value, 10);
      const out = $('#attackOut'); const kpi = $('#attackKpi'); const res = out.querySelector('.result');

      kpi.innerHTML='';
      res.classList.remove('muted');

      if(!weapon || !treffer?.Angriffstabellen?.[weapon]?.RK){
        res.textContent = '⚠️ Keine Angriffsdaten gefunden.';
        return;
      }
      if(Number.isNaN(attack)){
        res.textContent = 'Bitte einen Angriffswert eingeben.';
        return;
      }

      const rkBlock = treffer.Angriffstabellen[weapon].RK[String(rk)];
      if(!rkBlock){ res.textContent = `Keine Daten für RK ${rk}.`; return; }

      const fk = floorKey(rkBlock, attack);
      if(fk===null){ res.textContent = 'Kein passender Eintrag (Wert zu niedrig).'; return; }

      const entry = rkBlock[String(fk)];
      const tp = entry.trefferpunkte ?? '—';
      const kt = entry.krit_typ || '';
      const kk = entry.krit_kat || '';

      autoCrit.typ = mapCritName(kt) || '';
      autoCrit.kat = kk || '';

      kpi.append(chip(`Waffe: ${weapon}`));
      kpi.append(chip(`RK: ${rk}`));
      kpi.append(chip(`Tabelleneintrag: ${fk}`));

      const pillz = document.createElement('div');
      pillz.className='kpi';
      pillz.append(pill('Trefferpunkte', String(tp), 'ok'));
      if(kt && kk){
        pillz.append(pill('Krit', `${kt}-${kk}`, 'warn'));
        $('#critType').value = autoCrit.typ || '';
        $('#critCat').value  = autoCrit.kat  || '';
      } else {
        pillz.append(pill('Krit', '—', ''));
      }
      res.innerHTML = '';
      res.append(pillz);

      // Hintergrundmusik je nach Krit-Typ vorbereiten
      if(autoCrit.typ){
        const bgKey = autoCrit.typ;
        tryStartBgAudio(bgKey);
      }
    });

    // Kritischen Haupttreffer nachschlagen
    $('#calcCrit').addEventListener('click', () => {
      const roll = parseInt($('#critRoll').value,10);
      const typSel = $('#critType').value || autoCrit.typ;
      const katSel = $('#critCat').value || autoCrit.kat;

      const out = $('#critOut'); const kpi = $('#critKpi'); const res = out.querySelector('.result');
      kpi.innerHTML=''; res.classList.remove('muted');

      if(!roll || roll<1 || roll>100){ res.textContent = 'Bitte Wurf (1–100) eingeben.'; return; }
      if(!typSel || !katSel){ res.textContent = 'Krit-Typ und -Kategorie festlegen (oder Schritt 1 ausführen).'; return; }

      const found = lookupCritEntry(typSel, katSel, roll);
      if(!found){ res.textContent = `Kein Eintrag gefunden für ${typSel} ${katSel} (${roll}).`; return; }

      const { text, key } = found;

      kpi.append(chip(`Typ: ${typSel}`));
      kpi.append(chip(`Kat: ${katSel}`));
      kpi.append(chip(`Wurf: ${roll}`));
      if(key) kpi.append(chip(`Bereich: ${key}`));
      res.textContent = text;

      // Audio: erst MP3 versuchen, sonst TTS
      playCritAudio(typSel, katSel, key, text);
      tryStartBgAudio(typSel);
    });

    // Nebentreffer
    $('#calcSide').addEventListener('click', () => {
      const typ = $('#sideType').value;
      const kat = $('#sideCat').value;
      const roll = parseInt($('#sideRoll').value,10);

      const out = $('#sideOut'); const kpi = $('#sideKpi'); const res = out.querySelector('.result');
      kpi.innerHTML=''; res.classList.remove('muted');

      if(!typ){ res.textContent = 'Bitte eine Nebentreffer-Tabelle wählen.'; return; }
      if(!roll || roll<1 || roll>100){ res.textContent = 'Bitte Wurf (1–100) eingeben.'; return; }

      const found = lookupCritEntry(typ, kat, roll);
      if(!found){ res.textContent = `Kein Eintrag gefunden für ${typ} ${kat} (${roll}).`; return; }
      const { text, key } = found;

      kpi.append(chip(`Nebentyp: ${typ}`));
      kpi.append(chip(`Kat: ${kat}`));
      kpi.append(chip(`Wurf: ${roll}`));
      if(key) kpi.append(chip(`Bereich: ${key}`));
      res.textContent = text;

      playCritAudio(typ, kat, key, text);
      tryStartBgAudio(typ);
    });

    // Utilities: UI Chips/Pills
    function chip(t){ const s=document.createElement('span'); s.className='pill'; s.textContent=t; return s; }
    function pill(label, value, tone){ const w=document.createElement('div'); w.className='pill '+(tone||''); w.innerHTML = '<strong>'+label+':</strong> '+value; return w; }

    // Krit-Namen von Kürzel zu Tabellen-Key abbilden
    function mapCritName(kurz){
      if(!kurz) return '';
      const map = { 'P':'Stich', 'S':'Streich', 'K':'Hieb' };
      const base = map[kurz] || kurz;
      // Fallback auf vorhandene Tabellen-Schlüssel
      const keys = Object.keys(tables||{});
      if(keys.includes(base)) return base;
      const alt = keys.find(k => k.toLowerCase().startsWith(base.toLowerCase()));
      return alt || '';
    }

    // Bereichs-Parser: "1-5", "66", "≤5", "01-05"
    function matchRange(range, roll){
      range = String(range).trim();
      const z = (s)=>parseInt(String(s).replace(/^0+/,'')||'0',10);
      if(range.includes('-')){ const [a,b] = range.split('-'); return roll>=z(a)&&roll<=z(b); }
      if(range.startsWith('≤')){ return roll <= z(range.slice(1)); }
      if(range.startsWith('≥')){ return roll >= z(range.slice(1)); }
      return roll === z(range);
    }

    function sanitizeRangeForFile(rangeKey){
      let s = String(rangeKey).trim();
      s = s.replace(/[–—]/g,'-');
      s = s.replace(/\s+/g,'');
      if(s.includes('-')){
        const [a,b] = s.split('-');
        const nz = (x)=> String(parseInt(x,10));
        return nz(a) + '-' + nz(b);
      }
      s = s.replace(/[≤≥]/g,'');
      return String(parseInt(s,10));
    }

    function buildCritAudioFilename(typ, kat, rangeKey){
      if(!typ || !kat || !rangeKey) return null;
      const safeTyp = String(typ).replace(/\s+/g,'_');
      const safeKat = String(kat).toUpperCase();
      const safeRange = sanitizeRangeForFile(rangeKey);
      // Dateien liegen unter assets/audio/
      return `assets/audio/${safeTyp}_${safeKat}_${safeRange}.mp3`;
    }

    function lookupCritEntry(typ, kat, roll){
      const block = tables?.[typ];
      if(!block){ return null; }
      const cat = block?.[kat];
      if(!cat){ return null; }
      for(const key of Object.keys(cat)){
        if(matchRange(key, roll)){
          return { text: cat[key], key };
        }
      }
      return null;
    }

    // --- Audio ---
    const bgAudio = $('#bgAudio');
    const sfxAudio = $('#sfxAudio');

    $('#bgVol').addEventListener('input', e => { 
      bgAudio.volume = parseFloat(e.target.value || '0.18'); 
      sfxAudio.volume = Math.min(1, parseFloat(e.target.value || '0.18') + 0.07); // SFX leicht lauter
    });
    $('#bgPlay').addEventListener('click', ()=>{
      if(bgAudio.paused) bgAudio.play().catch(()=>{}); else bgAudio.pause();
    });

    // Mappe Tabellen/Typen -> passende BG-Musik-Datei unter assets/audio/
    function bgMusicFor(tableKey){
      const map = {
        'Streich': 'Helden_streich.mp3',
        'Hieb': 'hieb.mp3',
        'Stich': 'stich.mp3',
        'Schlag': 'schlag.mp3',
        'Hitze': 'feuer.mp3'
      };
      return map[tableKey] || 'fantasy-medieval-epic-music-239599.mp3';
    }

    function tryStartBgAudio(tableKey){
      // bevorzugt audioFile aus tables.json, sonst Mapping
      let file = tables?.[tableKey]?.audioFile || bgMusicFor(tableKey);
      if(!file) return;
      if(!file.startsWith('assets/')) file = 'assets/audio/' + file; // robust: relative Namen ergänzen
      if(currentBgKey === tableKey && !bgAudio.paused) return; // schon spielend
      currentBgKey = tableKey;
      bgAudio.src = file;
      bgAudio.volume = parseFloat($('#bgVol').value || '0.18');
      bgAudio.play().catch(()=>{});
    }

    function playCritAudio(typ, kat, rangeKey, fallbackText){
      const mp3 = buildCritAudioFilename(typ, kat, rangeKey);
      if(!mp3){ speak(fallbackText); return; }
      sfxAudio.pause();
      sfxAudio.currentTime = 0;
      sfxAudio.src = mp3;
      const onError = ()=>{ sfxAudio.removeEventListener('error', onError); speak(fallbackText); };
      sfxAudio.addEventListener('error', onError, { once:true });
      sfxAudio.play().catch(()=>{ speak(fallbackText); });
    }

    // --- TTS ---
    function speak(text){
      const enabled = $('#ttsToggle').checked;
      if(!enabled) return;
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'de-DE';
      utter.rate = 1.02;
      window.speechSynthesis.speak(utter);
    }

    // --- Reset ---
    $('#resetBtn').addEventListener('click', ()=>{
      $('#attack').value='';
      $('#critRoll').value='';
      $('#critOut .result').textContent='Noch kein Ergebnis.';
      $('#attackOut .result').textContent='Noch kein Ergebnis.';
      $('#sideOut .result').textContent='Noch kein Ergebnis.';
      $('#critKpi').innerHTML=''; $('#attackKpi').innerHTML=''; $('#sideKpi').innerHTML='';
      $('#critType').value=''; $('#critCat').value='';
      autoCrit={typ:'',kat:''};
      try{ bgAudio.pause(); }catch(_){ }
      try{ sfxAudio.pause(); }catch(_){ }
    });

    // --- PWA Basics ---
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBtn').hidden = false;
    });
    $('#installBtn').addEventListener('click', async () => {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('#installBtn').hidden = true;
    });

    // Service Worker (optional, nur für PWA-Shell)
    if('serviceWorker' in navigator){
      const sw = `
        const CORE = self.location.href;
        self.addEventListener('install', e=>{self.skipWaiting()});
        self.addEventListener('activate', e=>{clients.claim()});
        self.addEventListener('fetch', e=>{});
      `;
      const blob = new Blob([sw], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(()=>{});
    }

    // Init
    loadData().catch(err=>{
      console.error(err);
      alert('Fehler beim Laden der JSON-Dateien. Prüfe Pfade in assets/.');
    });
  </script>
</body>
</html>